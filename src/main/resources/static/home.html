<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Book Store Admin - Home</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        nav {
            margin-bottom: 1rem;
        }
        nav a {
            margin-right: 1rem;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        nav a:hover {
            text-decoration: underline;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>

<header>
    <h1>üìö Book Store </h1>
    <nav>
        <a href="book.html">Qu·∫£n l√Ω S√°ch</a>
        <a href="user.html">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
    </nav>
    <button id="logoutBtn">Logout</button>
    <p id="logoutMessage" class="error"></p>
</header>

<main>
    <section class="card">
        <h2>üîç T√¨m ki·∫øm s√°ch</h2>
        <input id="searchKeyword" placeholder="T√°c gi·∫£ / Ti√™u ƒë·ªÅ / Th·ªÉ lo·∫°i" style="width:300px;" />
        <button onclick="searchByAuthor()">T√¨m theo T√°c gi·∫£</button>
        <button onclick="searchByTitle()">T√¨m theo Ti√™u ƒë·ªÅ</button>
        <button onclick="searchByCategory()">T√¨m theo Th·ªÉ lo·∫°i</button>
    </section>

    <section class="card">
        <h3>üìã K·∫øt qu·∫£ t√¨m ki·∫øm s√°ch</h3>
        <div id="bookList"></div>
    </section>
</main>

<script>
    const API_BASE = window.location.origin;
    const accessToken = localStorage.getItem("accessToken");

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        const refreshToken = localStorage.getItem("refreshToken");
        if (!refreshToken) {
            document.getElementById("logoutMessage").textContent = "Kh√¥ng t√¨m th·∫•y refresh token!";
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/auth/logout`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ refreshToken })
            });
            const result = await res.json();
            if (res.ok && result.success) {
                localStorage.removeItem("accessToken");
                localStorage.removeItem("refreshToken");
                window.location.href = "/auth.html";
            } else {
                document.getElementById("logoutMessage").textContent = result.message || "Logout th·∫•t b·∫°i!";
            }
        } catch (err) {
            document.getElementById("logoutMessage").textContent = "L·ªói server: " + err.message;
        }
    });

    async function searchByAuthor() {
        const keyword = document.getElementById("searchKeyword").value.trim();
        if (!keyword) return alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm");
        await searchBooks(`by-author`, keyword);
    }

    async function searchByTitle() {
        const keyword = document.getElementById("searchKeyword").value.trim();
        if (!keyword) return alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm");
        await searchBooks(`by-title`, keyword);
    }

    async function searchByCategory() {
        const keyword = document.getElementById("searchKeyword").value.trim();
        if (!keyword) return alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm");
        await searchBooks(`by-category`, keyword);
    }

    async function searchBooks(type, keyword) {
        try {
            const url = new URL(`${API_BASE}/book/${type}`);
            url.searchParams.append("page", 0);
            url.searchParams.append("size", 5);
            url.searchParams.append(type === "by-category" ? "category" : type === "by-author" ? "author" : "title", keyword);

            const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${accessToken}` }
            });
            const result = await res.json();

            if (res.ok && result.success) {
                showBooks(result.data.content || []);
            } else {
                alert(result.message || "L·ªói khi t√¨m ki·∫øm s√°ch");
            }
        } catch (err) {
            alert("L·ªói server: " + err.message);
        }
    }

    function showBooks(books) {
        const html = books.length === 0
            ? "<p>Kh√¥ng c√≥ k·∫øt qu·∫£</p>"
            : books.map(b => `
        <div style="border:1px solid #ccc; margin:10px; padding:10px;">
          <b>Title:</b> ${b.title} <br/>
          <b>Author:</b> ${b.author} <br/>
          <b>Price:</b> ${b.price} <br/>
          <b>Stock:</b> ${b.stock} <br/>
          <b>Description:</b> ${b.description} <br/>
          <b>Category:</b> ${b.categoryName} <br/>
          <img src="${b.imgUrl}" alt="${b.title}" style="max-width:100px; max-height:100px;" />
        </div>
      `).join("");
        document.getElementById("bookList").innerHTML = html;
    }
</script>

</body>
</html>
